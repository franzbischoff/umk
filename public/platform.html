<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>UYAMAK platform</title>
	<link rel="manifest" href="manifest.json">
	<script src="https://www.gstatic.com/firebasejs/5.5/firebase.js"></script>
	<script src="js/config.js"></script>
	<script src="https://cdn.firebase.com/libs/firebaseui/3.5.2/firebaseui.js"></script>
	<link type="text/css" rel="stylesheet" href="https://cdn.firebase.com/libs/firebaseui/3.5.2/firebaseui.css" />
	<meta name="viewport" content="width=device-width, initial-scale=1">
	
	<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
	<link rel="stylesheet" href="https://www.w3schools.com/lib/w3-theme-w3schools.css">
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">
	
	
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css" />
	<script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
<style>
html, body, select {
	/*font: 9pt sans;*/
	width: 100%;
	height: 100%;
	margin: 0px;
}

#mynetwork {
	position:relative;
	width: 100%;
	height: 100%;
	border: 0px solid lightgray;
	box-sizing: content-box;
}

.ToolBarButton>div, .ToolBarButton>img {
	border-width: 2px !important;
	border-color: rgba(80,197,56,1) !important;
	width: 30px;
	height: 30px;
}

.ToolBarButton {
	padding: 2px;
	font-size: 15px;
    color: rgba(80,197,56,1);
	-webkit-user-drag: none;
    -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
	width: 34px;
	height: 34px;
	border-radius: 17px;
	display: inline-block;
	cursor: pointer;
	position: fixed;
}

.ToolBarButton:hover {
	box-shadow: 0 0 3px 3px rgba(56,207,21,.3);
}
.ToolBarButton:active {
	box-shadow: 0 0 1px 3px rgba(56,207,21,.95);
}
</style>
</head>
<body>
<div id="mynetwork"></div>
<div id="app">
<div id="waitForProcessToFinish" class="w3-modal w3-display-container">
	<div class="w3-display-middle w3-center w3-padding" style="background-color: rgba(255, 255, 255, 0.5);">
			<p id="DOMWaitingHead" class="w3-large"></p>
			<div class="fa-3x">
					<i class="fas fa-spinner fa-pulse"></i>
			</div>
			<p id="DOMWaitingDesc" class="w3-large"></p>
	</div>
</div>
			

<div class="w3-overlay w3-animate-opacity" onclick="closeLeftMenu()" style="cursor:pointer; position: fixed; left: 0px; top: 0px;" id="leftMenuOverlay"></div>
<div class="w3-sidebar w3-card w3-animate-left" style="z-index: 2; left: 0px; top: 0px; width: 500px; max-width: 100%; display: none;" id="leftMenu">
	<div>
			<div>
			<span class="w3-large">Add a block to your network</span>
			<span class="fa-stack w3-large w3-text-red w3-right" onclick="closeLeftMenu()" style="cursor: pointer; float:right;">
					<i class="far fa-circle fa-stack-2x"></i>
					<i class="fas fa-times fa-stack-1x"></i>
			</span>
		</div>
		<input class="w3-input w3-border w3-border-theme" type="text" v-model.trim="filterForFunctions" placeholder="Search for a block" :class="(!!filterForFunctions)?'w3-orange':''"/>
		<div class="w3-border-theme w3-border">
			<template v-for="(summaryItem, index) in blocksSummaryArray">
				<div class="w3-theme-l3 w3-border w3-border-theme w3-padding" @click="toggleBlockDisplay(index)" style="cursor: pointer;">
					<span v-if="blocksSummaryArray[index].display"><i class="fas fa-chevron-down"></i></span>
					<span v-else><i class="fas fa-chevron-right"></i></span>
					<span>{{summaryItem.name}}</span>
				</div>
				<div v-show="blocksSummaryArray[index].display" class="w3-row" :key="index+'_'+updatingCounter">
					<ul class="w3-ul">
					<template v-for="(block, index1) in getFilteredBlocks(blocksSummary[summaryItem.key].blocks)">
						<li class="w3-row w3-hover w3-hover-theme" style="cursor: pointer;" @click="addABlock(summaryItem.key, block.key, (blocksSummary[summaryItem.key].preIcon + block.icon + blocksSummary[summaryItem.key].postIcon))">
							<div class="w3-col s2">
									<img v-bind:src="svgTextToURL(blocksSummary[summaryItem.key].preIcon + block.icon + blocksSummary[summaryItem.key].postIcon)" class="tempSVGImg" style="width:100%">
							</div>
							<div class="w3-col s10">
								<div class="">
									<span class="w3-large"><b>{{block.name}}</b></span><br>
									<span class="w3-small"><i>{{block.description}}</i></span>
								</div>
							</div>
						</li>
					</template>
					</ul>
				</div>
			</template>
		</div>
	</div>
</div>

<div class="w3-sidebar w3-bar-block w3-card w3-animate-right" style="display:none;right:0;" id="rightMenu">
  <button onclick="closeRightMenu()" class="w3-bar-item w3-button w3-large">Close &times;</button>
  <a href="#" class="w3-bar-item w3-button">Link 1</a>
  <a href="#" class="w3-bar-item w3-button">Link 2</a>
  <a href="#" class="w3-bar-item w3-button">Link 3</a>
</div>

<div class="w3-display-container ToolBarButton"  style="top: 10px; right: 15px;" onclick="openLeftMenu()">
		<img v-bind:src="user.photoURL" class="w3-display-middle w3-circle w3-border" style="width: 30px; height: 30px;">
	</div>			
	
<template v-for="(tool, index) in tools">
	<div v-if="tool.display" class="w3-display-container ToolBarButton" v-bind:id="'GSK_Tool_'+index"
	v-bind:style= "'top:'+ (toolConsts.DOM.y - 1.5*toolConsts.toolDiameter)
				+'px; left:'+ (toolConsts.DOM.x - 0.5*toolConsts.toolDiameter + tool.order*40.0) +'px;'"
	onclick="openLeftMenu()">
		<div class="w3-display-middle w3-circle w3-border">
		<i class="w3-display-middle" v-bind:class="tool.icon"></i>
		</div>
	</div>			
</template>
</div>
<script src="https://code.jquery.com/jquery-3.4.0.min.js" integrity="sha256-BJeo0qm959uMBGb65z40ejJYGSgR7REI4+CW1fNKwOg=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>	
<script>
function removeAlltheObjectURLsForSVGImages() {
	var i;
	for (i=0; i< document.getElementsByClassName("tempSVGImg").length; i++) {
		var url = document.getElementsByClassName("tempSVGImg")[i].src
		URL.revokeObjectURL(url);
	}
	console.log("Cleaned images: "+ i);
}

function openLeftMenu() {
	document.getElementById("leftMenuOverlay").style.display = "block";
	document.getElementById("leftMenu").style.display = "block";
}

function closeLeftMenu() {
	document.getElementById("leftMenu").style.display = "none";
	document.getElementById("leftMenuOverlay").style.display = "none";
}

function openRightMenu() {
	document.getElementById("rightMenu").style.display = "block";
}

function closeRightMenu() {
	document.getElementById("rightMenu").style.display = "none";
}

$(document).keyup(function(e) {
     if (e.key === "Escape") { // escape key maps to keycode `27`
        closeLeftMenu();
		hideTools();
    }
});
</script>

<script>
/*Permananet Stuff Start*/
/*Global vars*/
var GSK_STATE = "DESIGN" ; // DESIGN, ADD_NODE

/*Permananet Stuff End*/


let svg ="<svg viewBox='0 0 120 120' xmlns='http://www.w3.org/2000/svg'><defs><filter id='f0' x='-50%' y='-50%' width='200%' height='200%'><feGaussianBlur in='SourceAlpha' stdDeviation='1'/><feOffset dx='2' dy='2' result='offsetblur'/><feMerge><feMergeNode/><feMergeNode in='SourceGraphic'/></feMerge></filter><filter id='f1' x='-50%' y='-50%' width='200%' height='200%'><feOffset result='offOut' in='SourceAlpha' dx='3' dy='3' /><feGaussianBlur result='blurOut' in='offOut' stdDeviation='1' /><feBlend in='SourceGraphic' in2='blurOut' mode='normal' /></filter></defs><g><rect rx='20' height='100' width='100' y='0' x='0' stroke-width='0' fill='#04FB6B' filter='url(#f0)'/></g><g stroke-linecap='round' filter='url(#f1)' width='100' height='100' stroke='#FC36A9' stroke-width='10'><line x1='10' y1='50' x2= '90' y2='50'  /><line x1='50' y1='10' x2= '50' y2='90'/></g></svg>";
let svg1 = "<svg viewBox='0 0 120 120' xmlns='http://www.w3.org/2000/svg'><defs><filter id='f0' x='-50%' y='-50%' width='200%' height='200%'><feGaussianBlur in='SourceAlpha' stdDeviation='1'/><feOffset dx='2' dy='2' result='offsetblur'/><feMerge><feMergeNode/><feMergeNode in='SourceGraphic'/></feMerge></filter><filter id='f1' x='-50%' y='-50%' width='200%' height='200%'><feOffset result='offOut' in='SourceAlpha' dx='3' dy='3' /><feGaussianBlur result='blurOut' in='offOut' stdDeviation='1' /><feBlend in='SourceGraphic' in2='blurOut' mode='normal' /></filter></defs><g><rect rx='20' height='100' width='100' y='0' x='0' stroke-width='0' fill='#04FB6B' filter='url(#f0)'/></g><g stroke-linecap='round' width='100' height='100' stroke='#FC36A9' stroke-width='10'><line x1='10' y1='50' x2= '90' y2='50'  /><line x1='50' y1='10' x2= '50' y2='90'/></g></svg>";
let blob = new Blob([svg], {type: 'image/svg+xml'});
let blob1 = new Blob([svg1], {type: 'image/svg+xml'});
let url = URL.createObjectURL(blob);
let url1 = URL.createObjectURL(blob1);
// create an array with nodes
var nodes = new vis.DataSet([
{id: "1", label: 'Node Node Node 1', title:"\\(a \\ne 0\\)"},
{id: "2", label: 'Node Node 2', image: {selected: url1, unselected: url}, shape: "image"},
{id: "3", label: 'Node 3'},
{id: "4", label: 'Node 4'},
{id: "5", label: 'Node 5'}
]);

// create an array with edges
var edges = new vis.DataSet([
{from: 1, to: 3},
{from: 1, to: 2},
{from: 2, to: 4},
{from: 2, to: 5},
{from: 3, to: 3}
]);

// create a network
var container = document.getElementById('mynetwork');
var data = {
nodes: nodes,
edges: edges
};
var options = {
	locale : "gsk",
	locales : {
		"gsk" : {
			edit : 'Edit',
			del : 'Delete selected',
			back : 'Back',
			addNode : 'Add block',
			addEdge : 'New connection',
			editNode : 'Edit block',
			editEdge : 'Edit connection',
			addDescription : 'Click in an empty space to place a new block.',
			edgeDescription : 'Click on a block and drag the connection to another block to connect them.',
			editEdgeDescription : 'Click on the control points and drag them to a block to connect to it.',
			createEdgeError : 'Cannot connect to a cluster.',
			deleteClusterError : 'Clusters cannot be deleted.',
			editClusterError : 'Clusters cannot be edited.'
		}
	},
	interaction : {
		navigationButtons : true,
		keyboard : true,
		multiselect : true,
	},
	nodes : {
		shape : 'box',
		color : {
			border : '#000000',
			background : "#ffffff",
		},
		font : {
			color : '#000000',
		},
	},
	edges : {
		//smooth : false,
		color : {
			color : '#000000',
		},
		arrows : {
			to : {
				enabled : true,
				scaleFactor : 1,
				type : 'arrow'
			}
		},
	},
	physics : {
		enabled : true,
		solver : 'barnesHut',
		barnesHut : {
			centralGravity : 0,
			springLength : 0,
			avoidOverlap : 1,
			damping : 1,
			springConstant : 0.00,
			gravitationalConstant : -1,
		},
		forceAtlas2Based : {
			springLength : 50,
			springConstant : 0,
			avoidOverlap : 1,
			centralGravity : 0.00,
			gravitationalConstant : -1
		},
	},
	manipulation: {
		enabled : false,
		addNode: function (data, callback) {
			data.image = ICON_FOR_ADD_BLOCK;
			data.shape = 'image';
			callback(data);
			document.getElementById('mynetwork').style.cursor = "";
			GSK_STATE = 'DESIGN';
		}
	}
};
var network = new vis.Network(container, data, options);
network.on("oncontext", function (params) {
console.log(params);
});  
network.on("showPopup", function (params) {
    console.log("DO SOMETHING");
	MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
})
network.on('click', function (params) {
	hideTools();
	console.log(params);
	tool_Order = 0;
	if (GSK_STATE === 'DESIGN') {
		var tempPoint;
		if ((params.nodes.length === 0) && (params.edges.length === 0)) {
			placeATool("addBlock", params.pointer.canvas);
			if (network.body.data.nodes.length)
			placeATool("addConnection");
		}
		else if (params.nodes.length === 1) {
			tempPoint = network.getPositions(params.nodes[0])[params.nodes[0]];
			tempPoint.x = tempPoint.x - network.body.nodes[params.nodes[0]].shape.width/2;
			tempPoint.y = tempPoint.y - network.body.nodes[params.nodes[0]].shape.height/2;
			placeATool("addConnection", tempPoint);
			placeATool("editBlock");
			placeATool("delete");
		}
		else if ((params.nodes.length === 0) && (params.edges.length === 1)) {
			tempPoint = {"x": 0, "y": 0};
			tempPoint.x = (network.body.edges[params.edges[0]].from.x + network.body.edges[params.edges[0]].to.x)/2;
			tempPoint.y = (network.body.edges[params.edges[0]].from.y + network.body.edges[params.edges[0]].to.y)/2;
			placeATool("editConnection", tempPoint);
			placeATool("delete");
		}
		else if ((params.nodes.length > 1) || (params.edges.length > 1)) {
			placeATool("delete");
		}
	}

});
network.on("afterDrawing", function (params) {
	try {
		newDOMXY = network.canvasToDOM({"x": app.$data.toolConsts.canvas.x, "y": app.$data.toolConsts.canvas.y})
		app.$set(app.$data.toolConsts.DOM, "x", newDOMXY.x)
		app.$set(app.$data.toolConsts.DOM, "y", newDOMXY.y)
	} catch (e) {
		console.log("App is not yet ready");
	}
	/*if (GSK_STATE === "DESIGN")
        PlaceTools();*/
});
var tool_Order = 0;
function placeATool(toolIndex, toolPoint=null) {
	//console.log(app.$data.tools[toolIndex]);
	if (toolPoint) {
		app.$set(app.$data.toolConsts.canvas, "x", toolPoint.x);
		app.$set(app.$data.toolConsts.canvas, "y", toolPoint.y);
	}
	app.$set(app.$data.tools[toolIndex], "display", true);
	app.$set(app.$data.tools[toolIndex], "order", tool_Order);
	tool_Order++;
}
function hideTools() {
	for (var tool in app.$data.tools) {
		app.$data.tools[tool].display = false;
	}
}
</script>

<script>
let ICON_FOR_ADD_BLOCK=null;
</script>

<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script>
var app = new Vue({
	"el": '#app',
	"data": {
		"updatingCounter": 0,
		"user": {"uid": "", "photoURL": ""},
		"toolConsts":{"toolDiameter": 36, "canvas": {"x": 0, "y": 0},  "DOM": {"x": 0, "y": 0}},
		"networkConst": {"scale": 0, "xView": 0, "yView": 1, "halfWidth": 0, "halfHeight": 0},
		"blocksSummary": null,
		"filterForFunctions": null,
		"hoverredBlock": {"name": "", "description": ""},
		"tools":{"newFile":{"icon":"fas fa-file","function":"openLeftMenu()","text":"New file","display":false,"y":"0","x":"0","order":"0"},"saveFile":{"icon":"far fa-save","function":"openLeftMenu()","text":"Save file","display":false,"y":"0","x":"40","order":"1"},"deleteFile":{"icon":"far fa-trash-alt","function":"openLeftMenu()","text":"Delete file","display":false,"y":"0","x":"80","order":"2"},"addBlock":{"icon":"far fa-plus-square","function":"openLeftMenu()","text":"Add block","display":false,"y":"0","x":"120","order":"3"},"editBlock":{"icon":"far fa-edit","function":"openLeftMenu()","text":"Edit block","display":false,"y":"0","x":"160","order":"4"},"addConnection":{"icon":"fas fa-project-diagram","function":"openLeftMenu()","text":"Add connection","display":false,"y":"0","x":"200","order":"5"},"editConnection":{"icon":"fas fa-pencil-alt","function":"openLeftMenu()","text":"Edit connection","display":false,"y":"0","x":"240","order":"6"},"delete":{"icon":"fas fa-eraser","function":"openLeftMenu()","text":"Delete","display":false,"y":"0","x":"280","order":"7"},"filesView":{"icon":"far fa-folder-open","function":"openLeftMenu()","text":"Files view","display":false,"y":"0","x":"320","order":"8"},"simView":{"icon":"fas fa-play","function":"openLeftMenu()","text":"Simulation view","display":false,"y":"0","x":"360","order":"9"}}
	},
	"beforeUpdate": function () {
		removeAlltheObjectURLsForSVGImages();
	},
	"computed": {
		"blocksSummaryArray": function () {
			try {
				const tempSourceArray = Object.keys(this.blocksSummary).map( function (key) {
					return {"key": key, "name": app.$data.blocksSummary[key].name, "order": app.$data.blocksSummary[key].order, "display": true};
				});
				console.log(tempSourceArray);
				return tempSourceArray.sort((a, b) => (a.order - b.order));
			} catch (e) {
				console.log (e);
				console.log ("Data is not ready for displaying categories");
			}
		}
	},
	"methods": {
		"addABlock": function (categoryID, blockID, pic){
			let url = this.svgTextToURL("<svg width='64px' height='64px' xmlns='http://www.w3.org/2000/svg'>"+pic+"</svg>");
			console.log(url);
			if (!! ICON_FOR_ADD_BLOCK) URL.revokeObjectURL(ICON_FOR_ADD_BLOCK);
			document.getElementById("mynetwork").style.cursor = "url("+url+"), auto";
			ICON_FOR_ADD_BLOCK = url;
			closeLeftMenu();
			GSK_STATE="ADD_NODE";
			network.addNodeMode();
		},
		"toggleBlockDisplay": function (index) {
			this.updatingCounter++;
			this.blocksSummaryArray[index].display = !this.blocksSummaryArray[index].display;
		},
		"setHoverredBlock": function (name, desc) {
			this.hoverredBlock.name = name;
			this.hoverredBlock.description = desc;
		},
		"svgTextToURL": function (svg) {
			svg = svg;
			let tempBlob = new Blob([svg], {type: 'image/svg+xml'});
			let url = URL.createObjectURL(tempBlob);
			return url;
		},
		"getFilteredBlocks": function (inBlocks) {
			try {
				const tempBlocksArray = [];
				for (let [key, value] of Object.entries(inBlocks)) {
					tempBlocksArray.push(Object.assign({"key": key}, value))
				}
				return tempBlocksArray
				.filter(tempBlocksArrayItem => {
					return ((! app.$data.filterForFunctions) || (tempBlocksArrayItem.name.toLowerCase().search(app.$data.filterForFunctions.toLowerCase())>=0) || (tempBlocksArrayItem.description.toLowerCase().search(app.$data.filterForFunctions.toLowerCase())>=0) );
				}).sort((a,b)=> {return (a.order - b.order);});
			} catch (e) {
				console.log (e);
				console.log ("Data is not ready for applying filter");
			}
		}
	}
})
</script>

<script>
function holdToFinishAProcess(title = null, description = null) {
	if (title) document.getElementById("waitForProcessToFinish").style.display='block';
	else document.getElementById("waitForProcessToFinish").style.display='none';
	if (title) document.getElementById("DOMWaitingHead").innerText = title;
	if (description) document.getElementById("DOMWaitingDesc").innerText = description;
}
holdToFinishAProcess("Connecting to the server.", "Please wait while loading the app. If this process takes longer than a minute, check your internet connection and refresh the page.");
</script>
<script>
var TempRecAttempt;
var functions = firebase.functions();
var db = firebase.firestore();
const settings = {timestampsInSnapshots: true};
db.settings(settings);
var validateUserSession = firebase.functions().httpsCallable('validateUserSession');
firebase.auth().onAuthStateChanged(function (user) {
	holdToFinishAProcess("Loading the app.")
	TempRecAttempt = setInterval(function () {
		console.log("attempt");
		if (app) {
			holdToFinishAProcess("Verifying the license.")
			clearInterval(TempRecAttempt);
			user ? handleSignedInUser(user) : handleSignedOutUser();
		}
	}, 500);
});
function handleSignedInUser(user) {
	validateUserSession().then(function (result) {
		console.log(result.data.isSuccess);
		if (result.data.isSuccess) loadTheGUI();
		else window.location.replace("/platform/admin?redirect=" + location.pathname);
	});		
}
function handleSignedOutUser() {
	window.location.replace("/sign-in?redirect=" + location.pathname);
}
function loadTheGUI() {
	app.$set(app.$data.user, 'uid', firebase.auth().currentUser.uid);
	app.$set(app.$data.user, 'photoURL', firebase.auth().currentUser.photoURL);
	db.collection("blocks-summary").get().then(function(querySnapshot) {
		querySnapshot.forEach(function(doc) {
			db.collection("blocks-summary").doc(doc.id).onSnapshot(function(doc) {
				console.log(doc.id, " => ", doc.data());
				if (!app.$data.blocksSummary) app.$set(app.$data, "blocksSummary", {});
				app.$set(app.$data.blocksSummary, doc.id, doc.data());
			});

		});
	});

	holdToFinishAProcess(false);
}
</script>
</body>
</html>
