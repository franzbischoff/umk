<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>UYAMAK platform</title>
	<link rel="manifest" href="manifest.json">
	<script src="https://www.gstatic.com/firebasejs/5.5/firebase.js"></script>
	<script src="js/config.js"></script>
	<script src="https://cdn.firebase.com/libs/firebaseui/3.5.2/firebaseui.js"></script>
	<link type="text/css" rel="stylesheet" href="https://cdn.firebase.com/libs/firebaseui/3.5.2/firebaseui.css" />
	<meta name="viewport" content="width=device-width, initial-scale=1">
	
	<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
	<!--link rel="stylesheet" href="https://www.w3schools.com/lib/w3-theme-w3schools.css"-->
	<link rel="stylesheet" href="https://www.w3schools.com/lib/w3-theme-teal.css">
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">
	
	
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css" />
	<script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
	<script src="https://code.jquery.com/jquery-3.4.0.min.js" integrity="sha256-BJeo0qm959uMBGb65z40ejJYGSgR7REI4+CW1fNKwOg=" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/6.0.3/math.min.js" integrity="sha256-TNeqgLgUT/0XFsg+YaC13WI8OyU2S9E5/5P79536W6A=" crossorigin="anonymous"></script>
	<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML'></script>
	<script src="/js/augmented-json-serialization-functions.js"></script>
	<script src="/js/notyf.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<style>
html, body, select {
	/*font: 9pt sans;*/
	width: 100%;
	height: 100%;
	margin: 0px;
	line-height: initial;
}

#mynetwork {
	position:relative;
	width: 100%;
	height: 100%;
	border: 0px solid lightgray;
	box-sizing: content-box;
}
.btnGreen, .btnGreen>div, .btnGreen>img, .btnGreen>i{
	color: rgba(80,197,56,1);
	border-color: rgba(80,197,56,1) !important;
}
.btnRed, .btnRed>div, .btnRed>img, .btnRed>i{
	color: #ff0000;
	border-color: #ff0000 !important;
}

.ToolBarButton>div, .ToolBarButton>img, .ToolBarButton>i {
	border-width: 2px !important;
	width: 30px;
	height: 30px;
}

.ToolBarButton {
	padding: 2px;
	font-size: 15px;
	-webkit-user-drag: none;
    -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
	width: 34px;
	height: 34px;
	border-radius: 17px;
	display: inline-block;
	cursor: pointer;
	position: fixed;
}

.btnGreen:hover {
	box-shadow: 0 0 3px 3px rgba(56,207,21,.3);
}
.btnGreen:active {
	box-shadow: 0 0 1px 3px rgba(56,207,21,.95);
}

.btnRed:hover {
	box-shadow: 0 0 3px 3px rgba(255,00,0,.3);
}
.btnRed:active {
	box-shadow: 0 0 1px 3px rgba(255,00,0,.95);
}

.rotateNote {
	-webkit-transform: rotate(90deg);
    -moz-transform: rotate(90deg);
    -o-transform: rotate(90deg);
    -ms-transform: rotate(90deg);
    transform: rotate(90deg);
}
</style>
</head>
<body>
<div id="mynetwork"></div>
<div id="app">
<div id="waitForProcessToFinish" class="w3-modal w3-display-container">
	<div class="w3-display-middle w3-center w3-padding" style="background-color: rgba(255, 255, 255, 0.9);">
			<p id="DOMWaitingHead" class="w3-large"></p>
			<div class="fa-3x">
					<i class="fas fa-spinner fa-pulse"></i>
			</div>
			<p id="DOMWaitingDesc" class="w3-large"></p>
	</div>
</div>
			

<div class="w3-overlay w3-animate-opacity" onclick="closeLeftMenu()" style="cursor:pointer; position: fixed; left: 0px; top: 0px;" id="leftMenuOverlay"></div>
<div class="w3-sidebar w3-card w3-animate-left" style="z-index: 2; left: 0px; top: 0px; width: 500px; max-width: 100%; display: none;" id="leftMenu">
	<span class="w3-right" onclick="" style="cursor: pointer; float: right; width: 55px; height: 55px; padding: 10px;">
		<div class="w3-display-container btnRed ToolBarButton" onclick="closeLeftMenu()">
			<i class="w3-display-middle w3-circle w3-border fas fa-times" style="font-size: 16px; padding-top: 5px; text-align: center;"></i>
		</div>
	</span>
	<div v-if="leftBarMode === 'ADD_BLOCK'">
		<p class="w3-xlarge" style="margin:0px;"><b>Add block</b></p>
		<p class="w3-small" style="margin:0px;"><i>Please selet one of the blocks shown below to place it on your network.</i></p>
		<input class="w3-input w3-border w3-border-theme" type="text" v-model.trim="filterForFunctions" placeholder="Search for a block" :class="(!!filterForFunctions)?'w3-orange':''"/>
		<template v-for="(summaryItem, index) in blocksSummaryArray">
			<div class="w3-theme-d3 w3-border w3-border-theme w3-padding w3-ripple" @click="toggleBlockDisplay(index)" style="cursor: pointer;" :key="index+'_'+updatingCounter">
				<span v-if="blocksSummaryArray[index].display"><i class="fas fa-caret-down fa-fw"></i></span>
				<span v-else><i class="fas fa-caret-right fa-fw"></i></span>
				<span>{{summaryItem.name}}</span>
			</div>
			<div v-show="blocksSummaryArray[index].display">
				<ul class="w3-ul">
				<template v-for="(block, index1) in getFilteredBlocks(blocksSummary[summaryItem.key].blocks)">
					<li class="w3-row w3-hover w3-hover-theme w3-border-theme" style="cursor: pointer; padding: 0px;" @click="addABlock(summaryItem.key, block.key)">
						<div class="w3-col s2 w3-center">
							<img v-bind:src="prepareSVGURL(iconText.icon1 + blocksSummary[summaryItem.key].colors.bg + iconText.icon2 + blocksSummary[summaryItem.key].colors.fg + iconText.icon3 + block.icon + iconText.icon4)" class="tempSVGImg" style="height:70px; max-width: 100%;">
						</div>
						<div class="w3-col s10">
							<div class="">
								<p class="" style="margin:0px;"><b>{{block.name}}</b></p>
								<p class="w3-small" style="margin:0px;"><i>{{block.description}}</i></p>
							</div>
						</div>
					</li>
				</template>
				</ul>
			</div>
		</template>
	</div>
	<div v-if="leftBarMode === 'EDIT_BLOCK'">
		<p class="w3-xlarge" style="margin:0px;"><b>Edit block parameters</b></p>
		<p class="w3-small" style="margin:0px;"><i>Modify the parameters and click save to chagne them.</i></p>
		<template v-for="(Parameter, index) in uyamakModel.Parameters">
			<div class="w3-theme-d3 w3-border w3-border-theme w3-padding w3-ripple" @click="toggleParamDisplay(index)" style="cursor: pointer;">
				<span v-if="!!parametersDisplay[index]" :key="index+'_'+updatingCounter"><i class="fas fa-caret-down fa-fw"></i></span>
				<span v-else :key="index+'_'+updatingCounter"><i class="fas fa-caret-right fa-fw"></i></span>
				<span>{{Parameter.Name}}</span>
			</div>
			<div v-if="!!parametersDisplay[index]" >
					<div v-if="(Parameter.Dimension === 'Vector') || (Parameter.Dimension === 'Matrix')" class="w3-center w3-border-bottom w3-border-theme w3-theme-d1">
						<div @click="valueDimensionsModify(0, index)" style="width: 40px; height: 40px; padding:0px;" v-if="" class="w3-circle w3-button w3-theme-l3 w3-hover-theme w3-ripple w3-border w3-border-theme w3-display-container rotateNote"><div class="w3-display-middle"><i class="fas fa-ellipsis-h"></i><i class="fas fa-plus-circle"></i></div></div>
						<div @click="valueDimensionsModify(1, index)" style="width: 40px; height: 40px; padding:0px;" v-if="" class="w3-circle w3-button w3-theme-l3 w3-hover-theme w3-ripple w3-border w3-border-theme w3-display-container rotateNote"><div class="w3-display-middle"><i class="fas fa-ellipsis-h"></i><i class="fas fa-minus-circle fa-rotate-90"></i></div></div>
						<div v-if="(Parameter.Dimension === 'Matrix')" @click="valueDimensionsModify(2, index)" style="width: 40px; height: 40px; padding:0px;" v-if="" class="w3-circle w3-button w3-theme-l3 w3-hover-theme w3-ripple w3-border w3-border-theme w3-display-container"><div class="w3-display-middle"><i class="fas fa-ellipsis-h"></i><i class="fas fa-plus-circle"></i></div></div>
						<div v-if="(Parameter.Dimension === 'Matrix')" @click="valueDimensionsModify(3, index)" style="width: 40px; height: 40px; padding:0px;" v-if="" class="w3-circle w3-button w3-theme-l3 w3-hover-theme w3-ripple w3-border w3-border-theme w3-display-container"><div class="w3-display-middle"><i class="fas fa-ellipsis-h"></i><i class="fas fa-minus-circle"></i></div></div>
					</div>
					<div class="w3-responsive">
					<table class="w3-table-all">
					<template v-for="(rowValue, index1) in uyamakModel.Parameters[index]['Value']">
						<tr v-if="(index1 === 0) && (Parameter.Dimension === 'Matrix')" style="padding: 0;">
							<td class="w3-light-gray w3-border w3-border-theme"></td>
						<template v-for="(value, index2) in uyamakModel.Parameters[index]['Value'][index1]">
							<td style="padding:0;" class="w3-light-gray w3-center w3-border w3-border-theme">{{index2+1}}</td>
						</template>
						</tr>
						<tr style="padding: 0;" class="w3-border-theme">
							<td  v-if="(Parameter.Dimension === 'Vector') || (Parameter.Dimension === 'Matrix')" style="padding:0; vertical-align: middle;" class="w3-light-gray w3-border w3-border-theme">{{(index1+1)}}</td>
						<template v-for="(value, index2) in uyamakModel.Parameters[index]['Value'][index1]">
							<td style="padding: 0;" class="w3-border w3-border-theme">
							<input v-if="(['Integer', 'Real', 'Complex', 'Text'].indexOf(Parameter.Type))>=0" v-bind:class="(!validateParamCellEntry(index, index1, index2))? 'w3-red':''" v-model.trim="uyamakModel.Parameters[index]['Value'][index1][index2]" class="w3-input w3-border-0" style="padding: 0; min-width: 75px; padding: 8px 0px;" v-bind:style="(Parameter.Type !== 'Text')?'text-align: right':''" type="text">
							<input v-if="Parameter.Type === 'Color'" v-bind:class="(!validateParamCellEntry(index, index1, index2))? 'w3-red':''" v-model.trim="uyamakModel.Parameters[index]['Value'][index1][index2]" class="w3-input w3-border-0" style="padding: 0; min-width: 75px; padding: 0px; min-height: 35px;" v-bind:style="(Parameter.Type !== 'Text')?'text-align: right':''" type='color'>
							</td>
						</template>
						</tr>
					</template>
					</table>
				</div>
			</div>
		</template>
		<div>
			<template v-if="invalidInputs.length>0">
				<p class="w3-xlarge" style="margin:0px;"><b>Input error(s)</b></p>
				<div v-html="inputErrors" class="w3-text-red"></div>
			</template>
			<template v-else-if="parametersValidationComments !== 'OK'">
				<p class="w3-xlarge" style="margin:0px;"><b>Incompatable parameters</b></p>
				<div v-html="parametersValidationComments"></div>
			</template>
			<template  v-else>
				<!--p class="w3-text-green"><i class="far fa-check-circle"></i> Everything looks good.</p-->
				<p class="w3-xlarge" style="margin:0px;"><b>Functionality</b></p>
				<p class="w3-small" style="margin:0px;"><i>The input and output to the blocks are given as $u(t)$ and $y(t)$ respectively. $t$ is the simulation time in seconds.</i></p>
				<div v-html="getBlockDetails()"></div>
				<div class="w3-center w3-panel">
					<div class="w3-btn w3-green" @click="saveParametersToNode()">Save and close</div>
					<div class="w3-btn w3-yellow" @click="saveParametersToNode(false)">Save</div>
					<div class="w3-btn w3-red" onclick="closeLeftMenu()">Cancel</div>
				</div>
			</template>
		</div>
	</div>
</div>

<div class="w3-sidebar w3-bar-block w3-card w3-animate-right" style="display:none;right:0;" id="rightMenu">
  <button onclick="closeRightMenu()" class="w3-bar-item w3-button w3-large">Close &times;</button>
  <a href="#" class="w3-bar-item w3-button">Link 1</a>
  <a href="#" class="w3-bar-item w3-button">Link 2</a>
  <a href="#" class="w3-bar-item w3-button">Link 3</a>
</div>

<div class="w3-display-container btnGreen ToolBarButton"  style="top: 10px; right: 15px;" onclick="openLeftMenu()">
	<img v-bind:src="user.photoURL" class="w3-display-middle w3-circle w3-border" style="width: 30px; height: 30px;">
</div>
<div v-if="networkState === 'DESIGN'" class="w3-display-container btnGreen ToolBarButton"  style="top: 10px; left: 15px;" onclick="openLeftMenu()">
	<i class="w3-display-middle w3-circle w3-border far fa-plus-square fa-fw" style="font-size: 16px; padding-top: 5px; text-align: center;"></i>
</div>
<div v-if="networkState === 'ADD_NODE'" class="w3-display-container btnRed ToolBarButton"  style="top: 10px; left: 15px;" onclick="disableEditMode()">
	<i class="w3-display-middle w3-circle w3-border fas fa-times fa-fw" style="font-size: 16px; padding-top: 5px; text-align: center;"></i>
</div>
	
<template v-for="(tool, index) in tools">
	<div v-if="tool.display" class="w3-display-container btnGreen ToolBarButton" v-bind:id="'GSK_Tool_'+index"
	v-bind:style= "'top:'+ (toolConsts.DOM.y - 1.5*toolConsts.toolDiameter)
				+'px; left:'+ (toolConsts.DOM.x - 0.0*toolConsts.toolDiameter + tool.order*40.0) +'px;'"
	v-bind:onclick="tool.function">
		<i class="w3-display-middle w3-circle w3-border fa-fw" v-bind:class="tool.icon" style="font-size: 16px; padding-top: 5px; text-align: center;"></i>
		<!--div class="w3-display-middle w3-circle w3-border">
		<i class="w3-display-middle" v-bind:class="tool.icon"></i-->
		</div>
	</div>			
</template>
</div>
<script>
function prepareSVGURL(svg){
	return "data:image/svg+xml;charset=utf-8,"+ encodeURIComponent(svg);
}
function openLeftMenu(content="ADD_BLOCK") {
	if (content === "EDIT_BLOCK") {
		app.$set(app.$data, "uyamakModel", createCopyOfModel(network.body.nodes[network.getSelectedNodes()[0]].options.uyamakModel));
		app.$set(app.$data, "parametersDisplay",new Array(app.$data.uyamakModel.Parameters.length).fill(false));
	}
	app.$data.leftBarMode = content;
	document.getElementById("leftMenuOverlay").style.display = "block";
	document.getElementById("leftMenu").style.display = "block";
}

function closeLeftMenu() {
	app.$data.leftBarMode = null;
	document.getElementById("leftMenu").style.display = "none";
	document.getElementById("leftMenuOverlay").style.display = "none";
}

function openRightMenu() {
	document.getElementById("rightMenu").style.display = "block";
}

function closeRightMenu() {
	document.getElementById("rightMenu").style.display = "none";
}

$(document).keyup(function(e) {
	if (e.key === "Escape") { // escape key maps to keycode `27`
		disableEditMode();
		closeLeftMenu();
		hideTools();
	}
});

function disableEditMode() {
	if (app.$data.networkState === "ADD_NODE") app.$data.networkState = "DESIGN";
	network.disableEditMode();
	document.getElementById("mynetwork").style.cursor = "";
}
</script>

<script>
/*Permananet Stuff Start*/
/*Global vars*/
const BLOCKS_LIB = {};
//var GSK_STATE = "DESIGN" ; // DESIGN, ADD_NODE
var GSK_CALLBACK;
var GSK_DATA;
/*Permananet Stuff End*/

var changeChosenNodeSize = function(values, id, selected, hovering) {
	values.size = 30;
}
var changeChosenNodeShadowColor = function(values, id, selected, hovering) {
	values.shadowColor = app.getColorsForTheCategory().bg;
	values.shadowX=0;
	values.shadowY=0;
	values.shadowSize = 20;
}
let svg ="<svg viewBox='0 0 120 120' xmlns='http://www.w3.org/2000/svg'><defs><filter id='f0' x='-50%' y='-50%' width='200%' height='200%'><feGaussianBlur in='SourceAlpha' stdDeviation='1'/><feOffset dx='2' dy='2' result='offsetblur'/><feMerge><feMergeNode/><feMergeNode in='SourceGraphic'/></feMerge></filter><filter id='f1' x='-50%' y='-50%' width='200%' height='200%'><feOffset result='offOut' in='SourceAlpha' dx='3' dy='3' /><feGaussianBlur result='blurOut' in='offOut' stdDeviation='1' /><feBlend in='SourceGraphic' in2='blurOut' mode='normal' /></filter></defs><g><rect rx='20' height='100' width='100' y='0' x='0' stroke-width='0' fill='#04FB6B' filter='url(#f0)'/></g><g stroke-linecap='round' filter='url(#f1)' width='100' height='100' stroke='#FC36A9' stroke-width='10'><line x1='10' y1='50' x2= '90' y2='50'  /><line x1='50' y1='10' x2= '50' y2='90'/></g></svg>";
let svg1 = "<svg viewBox='0 0 120 120' xmlns='http://www.w3.org/2000/svg'><defs><filter id='f0' x='-50%' y='-50%' width='200%' height='200%'><feGaussianBlur in='SourceAlpha' stdDeviation='1'/><feOffset dx='2' dy='2' result='offsetblur'/><feMerge><feMergeNode/><feMergeNode in='SourceGraphic'/></feMerge></filter><filter id='f1' x='-50%' y='-50%' width='200%' height='200%'><feOffset result='offOut' in='SourceAlpha' dx='3' dy='3' /><feGaussianBlur result='blurOut' in='offOut' stdDeviation='1' /><feBlend in='SourceGraphic' in2='blurOut' mode='normal' /></filter></defs><g><rect rx='20' height='100' width='100' y='0' x='0' stroke-width='0' fill='#04FB6B' filter='url(#f0)'/></g><g stroke-linecap='round' width='100' height='100' stroke='#FC36A9' stroke-width='10'><line x1='10' y1='50' x2= '90' y2='50'  /><line x1='50' y1='10' x2= '50' y2='90'/></g></svg>";
let blob = new Blob([svg], {type: 'image/svg+xml'});
let blob1 = new Blob([svg1], {type: 'image/svg+xml'});
let url = URL.createObjectURL(blob);
let url1 = URL.createObjectURL(blob1);
// create an array with nodes
var nodes = new vis.DataSet([
{id: "1", label: 'Node Node Node 1', title:"\\(a \\ne 0\\)"},
{id: "2", label: 'Node Node 2', color:"#00ff00", image: {selected: url1, unselected: url}, shape: "image", chosen: { label: false, node: changeChosenNodeShadowColor }},
{id: "3", label: 'Node 3', shape: 'star', chosen: { label: false, node: changeChosenNodeShadowColor }},
{id: "4", label: 'Node 4', color:"#ff0000"},
{id: "5", label: 'Node 5'}
]);

// create an array with edges
var edges = new vis.DataSet([
{from: 1, to: 3},
{from: 1, to: 2},
{from: 2, to: 4},
{from: 2, to: 5},
{from: 3, to: 3}
]);

// create a network
var container = document.getElementById('mynetwork');
var data = {
nodes: nodes,
edges: edges
};
var options = {
	locale : "gsk",
	locales : {
		"gsk" : {
			edit : 'Edit',
			del : 'Delete selected',
			back : 'Back',
			addNode : 'Add block',
			addEdge : 'New connection',
			editNode : 'Edit block',
			editEdge : 'Edit connection',
			addDescription : 'Click in an empty space to place a new block.',
			edgeDescription : 'Click on a block and drag the connection to another block to connect them.',
			editEdgeDescription : 'Click on the control points and drag them to a block to connect to it.',
			createEdgeError : 'Cannot connect to a cluster.',
			deleteClusterError : 'Clusters cannot be deleted.',
			editClusterError : 'Clusters cannot be edited.'
		}
	},
	interaction : {
		navigationButtons : true,
		//keyboard : true,
		multiselect : true,
	},
	nodes : {
		shape : 'box',
		color : {
			border : '#000000',
			background : "#ffffff",
		},
		font : {
			color : '#000000',
		},
	},
	edges : {
		color : {
			inherit : 'from',
		},
		arrows : {
			to : {
				enabled : true,
				scaleFactor : 1,
				type : 'arrow'
			}
		},
	},
	physics : {
		enabled : true,
		solver : 'barnesHut',
		barnesHut : {
			centralGravity : 0,
			springLength : 0,
			avoidOverlap : 1,
			damping : 1,
			springConstant : 0.00,
			gravitationalConstant : -1,
		},
		forceAtlas2Based : {
			springLength : 50,
			springConstant : 0,
			avoidOverlap : 1,
			centralGravity : 0.00,
			gravitationalConstant : -1
		},
	},
	manipulation: {
		enabled : false,
		addNode: function (data, callback) {
			//holdToFinishAProcess("Loading block information from server.");
			data.chosen = { label: false, node: changeChosenNodeShadowColor };
			data.shadow = {enabled: true, color: app.getColorsForTheCategory().fg, x:0, y:0};
			data.color = app.getColorsForTheCategory().bg;
			GSK_CALLBACK = callback;
			GSK_DATA = data;
			loadABlock();
			document.getElementById('mynetwork').style.cursor = "";
			app.$data.networkState = 'DESIGN';
		},
		editNode: function (data, callback) {
			GSK_CALLBACK = callback;
			GSK_DATA = data;
			assignDataToNode(app.$data.uyamakModel);
		}
	}
};
var network = new vis.Network(container, data, options);
network.on("oncontext", function (params) {
console.log(params);
});  
network.on("showPopup", function (params) {
    console.log("DO SOMETHING");
	MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
})
network.on('click', function (params) {
	placeTools (params);
});
network.on("dragEnd", function (params) {
	placeTools (params);
});
network.on("afterDrawing", function (params) {
	try {
		newDOMXY = network.canvasToDOM({"x": app.$data.toolConsts.canvas.x, "y": app.$data.toolConsts.canvas.y})
		app.$set(app.$data.toolConsts.DOM, "x", newDOMXY.x)
		app.$set(app.$data.toolConsts.DOM, "y", newDOMXY.y)
	} catch (e) {
		console.log("App is not yet ready");
	}
});
var tool_Order = 0;
function placeTools(params) {
	hideTools();
	console.log(params);
	tool_Order = 0;
	if (app.$data.networkState === 'DESIGN') {
		var tempPoint;
		if ((params.nodes.length === 0) && (params.edges.length === 0)) {
			/*placeATool("addBlock", params.pointer.canvas);
			if (network.body.data.nodes.length)
			placeATool("addConnection");*/
		}
		else if (params.nodes.length === 1) {
			tempPoint = network.getPositions(params.nodes[0])[params.nodes[0]];
			tempPoint.x = tempPoint.x - network.body.nodes[params.nodes[0]].shape.width/2;
			tempPoint.y = tempPoint.y - network.body.nodes[params.nodes[0]].shape.height/2;
			placeATool("addConnection", tempPoint);
			placeATool("editBlock");
			placeATool("delete");
		}
		else if ((params.nodes.length === 0) && (params.edges.length === 1)) {
			tempPoint = {"x": 0, "y": 0};
			tempPoint.x = (network.body.edges[params.edges[0]].from.x + network.body.edges[params.edges[0]].to.x)/2;
			tempPoint.y = (network.body.edges[params.edges[0]].from.y + network.body.edges[params.edges[0]].to.y)/2;
			placeATool("editConnection", tempPoint);
			placeATool("delete");
		}
		else if ((params.nodes.length > 1) || (params.edges.length > 1)) {
			placeATool("delete");
		}
	}
}
function placeATool(toolIndex, toolPoint=null) {
	//console.log(app.$data.tools[toolIndex]);
	if (toolPoint) {
		app.$set(app.$data.toolConsts.canvas, "x", toolPoint.x);
		app.$set(app.$data.toolConsts.canvas, "y", toolPoint.y);
	}
	app.$set(app.$data.tools[toolIndex], "display", true);
	app.$set(app.$data.tools[toolIndex], "order", tool_Order);
	tool_Order++;
}
function hideTools() {
	for (var tool in app.$data.tools) {
		app.$data.tools[tool].display = false;
	}
}
</script>

<script>
	//GLOBAL VARS
let ICON_FOR_ADD_BLOCK=null;
</script>

<script>
//MathJax setup
MathJax.Hub.Config({
	messageStyle: "none",
	menuSettings : {
		inTabOrder : false
	},
	extensions : ["tex2jax.js"],
	jax : ["input/TeX", "output/HTML-CSS"],
	tex2jax : {
		preview: "none",
		inlineMath : [["$", "$"], ["\\(", "\\)"]]
	}
});
/*MathJax.Hub.Config({
	menuSettings : {
		inTabOrder : false
	},
	extensions: ["tex2jax.js"],
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
      processEscapes: true
    },
    "HTML-CSS": { fonts: ["TeX"] }
});
MathJax.Hub.Configured();*/
</script>
<script>
var notyf = new Notyf();
</script>
<script>
var app = new Vue({
	"el": '#app',
	"data": {
		"networkState": "DESIGN",
		"leftBarMode": null,
		"uyamakModel": {},
		"parametersDisplay": null,
		"invalidInputs":[],
		"cid": null, //Category ID
		"bid": null, // Block ID
		"updatingCounter": 0,
		"user": {"uid": "", "photoURL": ""},
		"toolConsts":{"toolDiameter": 36, "canvas": {"x": 0, "y": 0},  "DOM": {"x": 0, "y": 0}},
		"networkConst": {"scale": 0, "xView": 0, "yView": 1, "halfWidth": 0, "halfHeight": 0},
		"blocksSummary": null,
		"filterForFunctions": null,
		"hoverredBlock": {"name": "", "description": ""},
		"iconText":{"icon1":"<svg viewBox='-3 -3 106 106' xmlns='http://www.w3.org/2000/svg'><defs><filter id='f0' x='-50%' y='-50%' width='200%' height='200%'><feGaussianBlur in='SourceAlpha' stdDeviation='1'/><feOffset dx='0' dy='0' result='offsetblur'/><feMerge><feMergeNode/><feMergeNode in='SourceGraphic'/></feMerge></filter><filter id='f1' x='-50%' y='-50%' width='200%' height='200%'><feOffset result='offOut' in='SourceAlpha' dx='3' dy='3' /><feGaussianBlur result='blurOut' in='offOut' stdDeviation='1' /><feBlend in='SourceGraphic' in2='blurOut' mode='normal' /></filter></defs><g><rect rx='20' height='100' width='100' y='0' x='0' stroke-width='0' fill='","icon2":"' filter='url(#f0)'/></g><g stroke-linecap='round' filter='url(#f1)' width='100' height='100' stroke='","icon3":"' stroke-width='10' fill='none'>","icon4":"</g></svg>"},
		"networkIcon":{"icon1":"<svg viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'><defs><filter id='f1' x='-50%' y='-50%' width='200%' height='200%'><feOffset result='offOut' in='SourceAlpha' dx='3' dy='3' /><feGaussianBlur result='blurOut' in='offOut' stdDeviation='0' /><feBlend in='SourceGraphic' in2='blurOut' mode='normal' /></filter></defs><g><rect rx='20' height='100' width='100' y='0' x='0' stroke-width='0' fill='","icon2":"'/></g><g stroke-linecap='round' filter='url(#f1)' width='100' height='100' stroke='","icon3":"' stroke-width='10' fill='none'>","icon4":"</g></svg>"},
		"tools":{"newFile":{"icon":"fas fa-file","function":"openLeftMenu()","text":"New file","display":false,"y":"0","x":"0","order":"0"},"saveFile":{"icon":"far fa-save","function":"openLeftMenu()","text":"Save file","display":false,"y":"0","x":"40","order":"1"},"deleteFile":{"icon":"far fa-trash-alt","function":"openLeftMenu()","text":"Delete file","display":false,"y":"0","x":"80","order":"2"},"addBlock":{"icon":"far fa-plus-square","function":"openLeftMenu('ADD_BLOCK')","text":"Add block","display":false,"y":"0","x":"120","order":"3"},"editBlock":{"icon":"far fa-edit","function":"openLeftMenu('EDIT_BLOCK')","text":"Edit block","display":false,"y":"0","x":"160","order":"4"},"addConnection":{"icon":"fas fa-project-diagram","function":"openLeftMenu()","text":"Add connection","display":false,"y":"0","x":"200","order":"5"},"editConnection":{"icon":"fas fa-pencil-alt","function":"openLeftMenu()","text":"Edit connection","display":false,"y":"0","x":"240","order":"6"},"delete":{"icon":"fas fa-eraser","function":"openLeftMenu()","text":"Delete","display":false,"y":"0","x":"280","order":"7"},"filesView":{"icon":"far fa-folder-open","function":"openLeftMenu()","text":"Files view","display":false,"y":"0","x":"320","order":"8"},"simView":{"icon":"fas fa-play","function":"openLeftMenu()","text":"Simulation view","display":false,"y":"0","x":"360","order":"9"}}
	},
	"beforeUpdate": function () {
		//removeAlltheObjectURLsForSVGImages();
	},
	"updated": function () {
		MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
	},
	"computed": {
		"parametersValidationComments": function () {
			return this.uyamakModel.ValidateParams();
		},
		"inputErrors": function () {
			return "<table class='w3-table'>" + this.invalidInputs.map(function(currentValue, index, arr){
				return "<tr><td>" + app.$data.uyamakModel.Parameters[parseInt(currentValue.split(",")[0])].Name + " at [" + (parseInt(currentValue.split(",")[1])+1) + ", " + (parseInt(currentValue.split(",")[2])+1) + "]"+"</td></tr>";
			}).join('') + "</table>";
		},
		"blocksSummaryArray": function () {
			try {
				const tempSourceArray = Object.keys(this.blocksSummary).map( function (key) {
					return {"key": key, "name": app.$data.blocksSummary[key].name, "order": app.$data.blocksSummary[key].order, "display": true};
				});
				console.log(tempSourceArray);
				return tempSourceArray.sort((a, b) => (a.order - b.order));
			} catch (e) {
				console.log (e);
				console.log ("Data is not ready for displaying categories");
			}
		}
	},
	"methods": {
		"saveParametersToNode": function (close=true) {
			network.editNode();
			if (close) closeLeftMenu();
		},
		"validateParamCellEntry": function(index, index1, index2) {
			var tempValidateItem = index+","+index1+","+index2;
			var outValue;
			var tempValue = this.uyamakModel.Parameters[index].Value[index1][index2];
			try {
				switch (this.uyamakModel.Parameters[index].Type) {
					case "Integer":
						outValue = ((typeof math.evaluate(tempValue) === 'number') && (math.evaluate(tempValue) % 1 === 0));
						break;
					case "Real":
						outValue = (typeof math.evaluate(tempValue) === 'number');
						break;
					case "Complex":
						outValue = ((math.evaluate(tempValue).type === 'Complex') || (typeof math.evaluate(tempValue) === 'number'));
						break;
					case "Text":
					case "Color":
					case "Option":
						outValue = (tempValue !== "" && tempValue !== null);
						break;
				}
			} catch(e){
				console.log(e);
				outValue = false;
			}
			var tempIndex = this.invalidInputs.indexOf(tempValidateItem)
			if (outValue) {
				if (tempIndex >= 0) this.invalidInputs.splice(tempIndex, 1);
			} else {
				if (tempIndex < 0) this.invalidInputs.push(tempValidateItem);
			}
			return outValue;
		},
		"getBlockDetails": function () {
			try {
				return this.uyamakModel.Details();
			} catch (e) {
				console.log(e);
				return "¡¡¡UNKNOWN ERROR!!!. If this error continues, please contact the support.";
			}
		},
		"valueDimensionsModify": function (func, index) {
			var tempItem;
			switch (this.uyamakModel.Parameters[index].Type) {
				case "Integer":
				case "Real":
				case "Complex":
					tempItem = 0;
					break;
				case "Text":
					tempItem = "";
					break;
				case "Color":
					tempItem = "Black";
					break;
			}
			switch (func) {
				case 0:
					this.uyamakModel.Parameters[index].Value.push(new Array(this.uyamakModel.Parameters[index].Value[0].length).fill(tempItem));
					break;
				case 1:
					if (this.uyamakModel.Parameters[index].Value.length>1) this.uyamakModel.Parameters[index].Value.pop();
					break;
				case 2:
					this.uyamakModel.Parameters[index].Value.map(function(val){return val.push(tempItem);})
					break;
				case 3:
				if (this.uyamakModel.Parameters[index].Value[0].length>1) {
					this.uyamakModel.Parameters[index].Value.map(function(val){return val.pop();})
				}
				break;
			}
			this.updatingCounter++;
		},
		"getColorsForTheCategory": function() {
			try {
				return this.blocksSummary[this.cid].colors;
			} catch(e) {
				return {"fg": "#000000", "bg": "#ffffff"}
			}
		},
		"createIconForNetwork": function(){
			return "data:image/svg+xml;charset=utf-8,"+ encodeURIComponent(
				this.networkIcon.icon1 + this.blocksSummary[this.cid].colors.bg + this.networkIcon.icon2 + this.blocksSummary[this.cid].colors.fg + this.networkIcon.icon3 + this.blocksSummary[this.cid].blocks[this.bid].icon  + this.networkIcon.icon4
			);
		},
		"addABlock": function (categoryID, blockID){
			this.cid = categoryID;
			this.bid = blockID;
			pic = this.iconText.icon1 + this.blocksSummary[categoryID].colors.bg + this.iconText.icon2 + this.blocksSummary[categoryID].colors.fg + this.iconText.icon3 + this.blocksSummary[categoryID].blocks[blockID].icon + this.iconText.icon4;
			let url = this.svgTextToURL("<svg width='64px' height='64px' xmlns='http://www.w3.org/2000/svg'>"+pic+"</svg>");
			console.log(url);
			if (!! ICON_FOR_ADD_BLOCK) URL.revokeObjectURL(ICON_FOR_ADD_BLOCK);
			document.getElementById("mynetwork").style.cursor = "url("+url+"), auto";
			ICON_FOR_ADD_BLOCK = url;
			closeLeftMenu();
			this.networkState ="ADD_NODE";
			network.addNodeMode();
		},
		"toggleParamDisplay": function (index) {
			console.log(this.parametersDisplay);
			this.updatingCounter++;
			this.parametersDisplay[index] = !this.parametersDisplay[index];
		},
		"toggleBlockDisplay": function (index) {
			this.updatingCounter++;
			this.blocksSummaryArray[index].display = !this.blocksSummaryArray[index].display;
		},
		"prepareSVGURL": function (svg) {
			return "data:image/svg+xml;charset=utf-8,"+ encodeURIComponent(svg);
		},
		"svgTextToURL": function (svg) {
			svg = svg;
			let tempBlob = new Blob([svg], {type: 'image/svg+xml'});
			let url = URL.createObjectURL(tempBlob);
			return url;
		},
		"getFilteredBlocks": function (inBlocks) {
			try {
				const tempBlocksArray = [];
				for (let [key, value] of Object.entries(inBlocks)) {
					tempBlocksArray.push(Object.assign({"key": key}, value))
				}
				return tempBlocksArray
				.filter(tempBlocksArrayItem => {
					return ((! app.$data.filterForFunctions) || (tempBlocksArrayItem.name.toLowerCase().search(app.$data.filterForFunctions.toLowerCase())>=0) || (tempBlocksArrayItem.description.toLowerCase().search(app.$data.filterForFunctions.toLowerCase())>=0) );
				}).sort((a,b)=> {return (a.order - b.order);});
			} catch (e) {
				console.log (e);
				console.log ("Data is not ready for applying filter");
			}
		}
	}
})
</script>

<script>
function holdToFinishAProcess(title = null, description = null) {
	if (title) document.getElementById("waitForProcessToFinish").style.display='block';
	else document.getElementById("waitForProcessToFinish").style.display='none';
	if (title) document.getElementById("DOMWaitingHead").innerText = title;
	if (description) document.getElementById("DOMWaitingDesc").innerText = description;
}
holdToFinishAProcess("Connecting to the server.", "Please wait while loading the app. If this process takes longer than a minute, check your internet connection and refresh the page.");
</script>
<script>
var TempRecAttempt;
var functions = firebase.functions();
var db = firebase.firestore();
const settings = {timestampsInSnapshots: true};
db.settings(settings);
var validateUserSession = firebase.functions().httpsCallable('validateUserSession');
firebase.auth().onAuthStateChanged(function (user) {
	holdToFinishAProcess("Loading the app.")
	TempRecAttempt = setInterval(function () {
		console.log("attempt");
		if (app) {
			holdToFinishAProcess("Verifying the license.")
			clearInterval(TempRecAttempt);
			user ? handleSignedInUser(user) : handleSignedOutUser();
		}
	}, 500);
});
function handleSignedInUser(user) {
	validateUserSession().then(function (result) {
		console.log(result.data.isSuccess);
		if (result.data.isSuccess) loadTheGUI();
		else window.location.replace("/platform/admin?redirect=" + location.pathname);
	});		
}
function handleSignedOutUser() {
	window.location.replace("/sign-in?redirect=" + location.pathname);
}
function loadTheGUI() {
	app.$set(app.$data.user, 'uid', firebase.auth().currentUser.uid);
	app.$set(app.$data.user, 'photoURL', firebase.auth().currentUser.photoURL);
	db.collection("blocks-summary").get().then(function(querySnapshot) {
		querySnapshot.forEach(function(doc) {
			db.collection("blocks-summary").doc(doc.id).onSnapshot(function(doc) {
				console.log(doc.id, " => ", doc.data());
				if (!app.$data.blocksSummary) app.$set(app.$data, "blocksSummary", {});
				app.$set(app.$data.blocksSummary, doc.id, doc.data());
			});

		});
	});

	holdToFinishAProcess(false);
}

const blockTemplate=[{"name":"Category","type":"string","argument":""},{"name":"Name","type":"string","argument":""},{"name":"Description","type":"string","argument":""},{"name":"Parameters","type":"json","argument":""},{"name":"Label","type":"function","argument":""},{"name":"MaxInTerminals","type":"float","argument":""},{"name":"MaxOutTerminals","type":"float","argument":""},{"name":"Icon","type":"function","argument":""},{"name":"Init","type":"function","argument":""},{"name":"End","type":"function","argument":""},{"name":"Constructor","type":"function","argument":"Data"},{"name":"Destructor","type":"function","argument":"Data"},{"name":"RunTimeExec","type":"function","argument":""},{"name":"Evaluate","type":"function","argument":""},{"name":"Details","type":"function","argument":""},{"name":"ValidateParams","type":"function","argument":""}];
function loadABlock () {
	holdToFinishAProcess("Downloading the block from server");
	try {
	if (!BLOCKS_LIB || ! BLOCKS_LIB[app.$data.bid]) {
			db.collection("blocks").doc(app.$data.bid).get()
			.then(function (doc){
				holdToFinishAProcess("Loading block's functionaliy");
				if(doc.exists) {
					convertDBDataToModel(doc.id, doc.data());
					assignDataToNode(BLOCKS_LIB[app.$data.bid]);
				}
				else throw("Uyamak: Block Not found");
			});
	} else {
		assignDataToNode(BLOCKS_LIB[app.$data.bid]);
	}
	} catch (e) {
		console.log(e);
		GSK_CALLBACK(null);
		holdToFinishAProcess(false);
		notyf.error('Error in adding this block.');
	}
}
function createIconForNetwork(cid, iconText) {
	return "data:image/svg+xml;charset=utf-8,"+ encodeURIComponent(
		app.$data.networkIcon.icon1 + app.$data.blocksSummary[cid].colors.bg + app.$data.networkIcon.icon2 + app.$data.blocksSummary[cid].colors.fg + app.$data.networkIcon.icon3 + iconText + app.$data.networkIcon.icon4
	);
}
function createCopyOfModel(inModel) {
	var outValue = JSON.parse2(JSON.stringify2(inModel));
	blockTemplate.forEach(function (item) {
		if (item.type === 'function') {
			outValue[item.name] = inModel[item.name];
		}
	});
	return outValue;
}
function assignDataToNode(inModel) {
	GSK_DATA.uyamakModel = createCopyOfModel(inModel);
	GSK_DATA.uyamakModel.Constructor(GSK_DATA);
	var tempIconData = GSK_DATA.uyamakModel.Icon();
	GSK_DATA.shape = tempIconData.shape;
	if (GSK_DATA.shape === "image") GSK_DATA.image = createIconForNetwork(GSK_DATA.uyamakModel.Category, tempIconData.icon);
	GSK_DATA.label = GSK_DATA.uyamakModel.Label();
	GSK_DATA.title = GSK_DATA.uyamakModel.Details();
	GSK_CALLBACK(GSK_DATA);
	holdToFinishAProcess(false);
}
function convertDBDataToModel(bid, dbBlockData) {
	BLOCKS_LIB[bid]={};
	blockTemplate.forEach(function (item){
		let tempObj = {};
		switch(item.type){
			case "float":
				if (! dbBlockData[item.name]) tempObj[item.name] = 0;
				else tempObj[item.name] = parseFloat(dbBlockData[item.name]);
				Object.assign(BLOCKS_LIB[bid], tempObj);
				break;
			case "string":
				if (! dbBlockData[item.name]) tempObj[item.name] = "";
				else tempObj[item.name] = dbBlockData[item.name].toString();
				Object.assign(BLOCKS_LIB[bid], tempObj);
				break
			case "function":
				if (! dbBlockData[item.name]) tempObj[item.name] = "";
				else tempObj[item.name] = dbBlockData[item.name].toString();
				tempObj[item.name] = eval("(function ("+ item.argument +"){" + dbBlockData[item.name] + "})");
				Object.assign(BLOCKS_LIB[bid], tempObj);
				break;
			case "json":
				if (! dbBlockData[item.name]) tempObj[item.name] = [];
				else tempObj[item.name] = JSON.parse(dbBlockData[item.name]);
				Object.assign(BLOCKS_LIB[bid], tempObj);
				break;
		}
	});
}
</script>
</body>
</html>
