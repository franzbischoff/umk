<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>UYAMAK: Add blocks</title>
	<link rel="manifest" href="manifest.json">
	<script src="https://www.gstatic.com/firebasejs/5.5/firebase.js"></script>
	<script src="js/config.js"></script>
	<script src="https://cdn.firebase.com/libs/firebaseui/3.5.2/firebaseui.js"></script>
	<link type="text/css" rel="stylesheet" href="https://cdn.firebase.com/libs/firebaseui/3.5.2/firebaseui.css" />
	<meta name="viewport" content="width=device-width, initial-scale=1">
	
	<link rel="stylesheet" href="/css/notyf.min.css">

	<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
	<link rel="stylesheet" href="https://www.w3schools.com/lib/w3-theme-w3schools.css">
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">
	
	
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css" />
	<script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
</head>
<body>
<div id="app">
<div v-if="waitForAProcess.show" class="w3-modal w3-display-container" style="display: block;">
	<div class="w3-display-middle w3-center w3-padding" style="background-color: rgba(255, 255, 255, 0.5);">
			<p v-html="waitForAProcess.title" class="w3-large">Connecting to server</p>
			<div class="fa-3x">
					<i class="fas fa-spinner fa-pulse"></i>
			</div>
			<p v-html="waitForAProcess.text" class="w3-large">Please wait while loading the app. If this process takes longer than a minute, check your internet connection and refresh the page.</p>
	</div>
</div>
<div class="w3-padding" style="max-width: 500px; width:100%; margin: 0 auto; z-index: 2;" v-if="!selectedBlock">
	<div>
		<label>Choose a category</label>
		<select class="w3-select w3-border w3-border-theme" style="cursor: pointer;" v-model="selectedCategory">
			<option value="" disabled selected>Choose a category</option>
			<option v-for="(option, index) in functionsCategories" v-bind:value="index">{{option.text}}</option>
		</select>
		<div class="w3-small">{{functionsCategories[selectedCategory].description}}</div>
		<div class="w3-btn w3-ripple w3-block" @click="showSummaryItem()">Add a new function</div>
		<input class="w3-input w3-border w3-border-theme" v-model="filterForFunctions" type="text" placeholder="Search ...">
		<ul class="w3-ul w3-border w3-border-theme">
			<li class="w3-bar w3-border-theme w3-button w3-ripple w3-hover-theme" v-for="(block, index) in filteredBlocks" style="cursor: pointer;" v-on:click="showSummaryItem(index)" v-bind:class="(selectedBlock === index)?'w3-text-theme':''">
				<img  v-bind:src="svgTextToURL(block.icon)" class="w3-bar-item tempSVGImg" style="height: 42.4px; padding: 0">
				<div class="w3-bar-item" v-bind:title="block.description">
					<span class="w3-large">{{block.name}}</span>
				</div>
			</li>
		</ul>
	</div>
</div>
<div class="w3-sidebar w3-card w3-padding" style="width:calc(50% - 5px);" v-if= "selectedBlock">
	<div>
		<h1>{{functionsCategories[selectedCategory].text}} > {{tempSummaryItem.name}}</h1>
		<label>Index: {{selectedBlock}}</label><br/>
		<label>Name</label>
		<input class="w3-input w3-border w3-border-theme" type="text" v-model="tempSummaryItem.name">
		<label>Description</label>
		<input class="w3-input w3-border w3-border-theme" type="text" v-model="tempSummaryItem.description">
		<label>Icon</label>
		<div class="w3-row">
			<div class="w3-col s6">
				<textarea class="w3-input w3-border w3-border-theme" style="resize: none; height: 300px;  font-family: monospace;" v-model="tempSummaryItem.icon"></textarea>
			</div>
			<div class="w3-col s6 w3-center">
				<img v-bind:src="svgTextToURL(tempSummaryItem.icon)" class="w3-bar-item tempSVGImg" style="height: 300px; padding: 0">
			</div>
		</div>
		<label>Order</label>
		<input class="w3-input w3-border w3-border-theme" type="number" v-model="tempSummaryItem.order">
		<div class="w3-bar" style="margin-top: 16px;">
			<div class="w3-bar-item w3-btn w3-green" style="width:33.3%" @click="saveDataToServer()">Save</div>
			<div class="w3-bar-item w3-btn w3-black" style="width:33.3%" @click="selectedBlock=null">Cancel</div>
			<div class="w3-bar-item w3-btn w3-red" style="width:33.3%" @click="deleteDataOnServer()">Delete</div>
		</div>
	</div>
</div>
<div class="w3-sidebar w3-card w3-padding" style="width:calc(50% - 5px); right:0;" v-if= "selectedBlock">
	<h1>Block details</h1>
	<label>Item = {Name:</label>
	<input class="w3-input w3-border w3-border-theme" v-model="tempSummaryItem.name">
	<label>, Description:</label>
	<input class="w3-input w3-border w3-border-theme" v-model="tempSummaryItem.description">
	<label>, Icon: function () {</label>
	<textarea class="w3-input w3-border w3-border-theme" style="resize: vertical; height: 50px;  font-family: monospace;" v-model="tempBlock.Icon"></textarea>
	<label>}, Parameters:</label>
	<textarea class="w3-input w3-border w3-border-theme" style="resize: vertical; height: 50px;  font-family: monospace;" v-model="tempBlock.Parameters"></textarea>
	<label>, Label: function () {</label>
	<textarea class="w3-input w3-border w3-border-theme" style="resize: vertical; height: 50px;  font-family: monospace;" v-model="tempBlock.Label"></textarea>
	<label>}, MaxInTerminals:</label>
	<input class="w3-input w3-border w3-border-theme" v-model="tempBlock.MaxInTerminals">
	<label>, MaxOutTerminals:</label>
	<input class="w3-input w3-border w3-border-theme" v-model="tempBlock.MaxOutTerminals">
	<label>, Init: function () {</label>
	<textarea class="w3-input w3-border w3-border-theme" style="resize: vertical; height: 50px;  font-family: monospace;" v-model="tempBlock.Init"></textarea>
	<label>}, End: function () {</label>
	<textarea class="w3-input w3-border w3-border-theme" style="resize: vertical; height: 50px;  font-family: monospace;" v-model="tempBlock.End"></textarea>
	<label>}, Constructor: function () {</label>
	<textarea class="w3-input w3-border w3-border-theme" style="resize: vertical; height: 50px;  font-family: monospace;" v-model="tempBlock.Constructor"></textarea>
	<label>}, Destructor: function () {</label>
	<textarea class="w3-input w3-border w3-border-theme" style="resize: vertical; height: 50px;  font-family: monospace;" v-model="tempBlock.Destructor"></textarea>
	<label>}, RunTimeExec: function () {</label>
	<textarea class="w3-input w3-border w3-border-theme" style="resize: vertical; height: 50px;  font-family: monospace;" v-model="tempBlock.RunTimeExec"></textarea>
	<label>}, Evaluate: function () {</label>
	<textarea class="w3-input w3-border w3-border-theme" style="resize: vertical; height: 50px;  font-family: monospace;" v-model="tempBlock.Evaluate"></textarea>
	<label>}, Details: function () {</label>
	<textarea class="w3-input w3-border w3-border-theme" style="resize: vertical; height: 50px;  font-family: monospace;" v-model="tempBlock.Details"></textarea>
	<label>}, ValidateParams: function () {</label>
	<textarea class="w3-input w3-border w3-border-theme" style="resize: vertical; height: 50px;  font-family: monospace;" v-model="tempBlock.ValidateParams"></textarea>
	<label>}}</label>
</div>


</div>
<script>
//Common.js

Object.filter = (obj, predicate) => 
    Object.keys(obj)
          .filter( key => predicate(obj[key]) )
          .reduce( (res, key) => (res[key] = obj[key], res), {} );


</script>
<script>
function removeAlltheObjectURLsForSVGImages() {
	var i;
	for (i=0; i< document.getElementsByClassName("tempSVGImg").length; i++) {
		var url = document.getElementsByClassName("tempSVGImg")[i].src
		URL.revokeObjectURL(url);
	}
	console.log("Cleaned images: "+ i);
}
</script>
<script src="/js/notyf.min.js"></script>
<script>
var notyf = new Notyf();
</script>
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script>
var app = new Vue({
	"el": '#app',
	"data": {
		"waitForAProcess": {"show": 1, "title": "Loading database", "text": "Please wait while loading the app. If this process takes longer than a minute, check your internet connection and refresh the page."},
		"filterForFunctions": "",
		"selectedCategory": "sources",
		"selectedBlock": null,
		"tempSummaryItem":null,
		"tempBlock": null,
		"toolConsts":{"toolDiameter": 36, "canvas": {"x": 0, "y": 0},  "DOM": {"x": 0, "y": 0}},
		"networkConst": {"scale": 0, "xView": 0, "yView": 1, "halfWidth": 0, "halfHeight": 0},
		"sources":{},"sinks":{},"basics":{},"logics":{},"continuous":{},"discrete":{},"hardware":{},"functionsCategories":{"sources":{"text":"Sources","description":"Sources generate the signals to feed to the model.","order":"0","preIcon":"<svg viewBox='0 0 120 120' xmlns='http://www.w3.org/2000/svg'><defs><filter id='f0' x='-50%' y='-50%' width='200%' height='200%'><feGaussianBlur in='SourceAlpha' stdDeviation='3'/><feOffset dx='2' dy='2' result='offsetblur'/><feMerge><feMergeNode/><feMergeNode in='SourceGraphic'/></feMerge></filter><filter id='f1' x='-50%' y='-50%' width='200%' height='200%'><feOffset result='offOut' in='SourceAlpha' dx='5' dy='5' /><feGaussianBlur result='blurOut' in='offOut' stdDeviation='5' /><feBlend in='SourceGraphic' in2='blurOut' mode='normal' /></filter></defs><g><rect rx='5' height='100' width='100' y='10' x='10' stroke-width='0' fill='#04FB6B' filter='url(#f0)'/></g><g stroke-linecap='round' filter='url(#f1)' width='100' height='100' stroke='#36FC89' stroke-width='10'>","postIcon":"</g></svg>"},"sinks":{"text":"Sinks","description":"Sinks output the information. They can be graphs or file download","order":"1","preIcon":"<svg viewBox='0 0 120 120' xmlns='http://www.w3.org/2000/svg'><defs><filter id='f0' x='-50%' y='-50%' width='200%' height='200%'><feGaussianBlur in='SourceAlpha' stdDeviation='3'/><feOffset dx='2' dy='2' result='offsetblur'/><feMerge><feMergeNode/><feMergeNode in='SourceGraphic'/></feMerge></filter><filter id='f1' x='-50%' y='-50%' width='200%' height='200%'><feOffset result='offOut' in='SourceAlpha' dx='5' dy='5' /><feGaussianBlur result='blurOut' in='offOut' stdDeviation='5' /><feBlend in='SourceGraphic' in2='blurOut' mode='normal' /></filter></defs><g><rect rx='5' height='100' width='100' y='10' x='10' stroke-width='0' fill='#0000FF' filter='url(#f0)'/></g><g stroke-linecap='round' filter='url(#f1)' width='100' height='100' stroke='#00FF7F' stroke-width='10'>","postIcon":"</g></svg>"},"basics":{"text":"Basic operations","description":"Basic mathematical operations are given","order":"2","preIcon":"<svg viewBox='0 0 120 120' xmlns='http://www.w3.org/2000/svg'><defs><filter id='f0' x='-50%' y='-50%' width='200%' height='200%'><feGaussianBlur in='SourceAlpha' stdDeviation='3'/><feOffset dx='2' dy='2' result='offsetblur'/><feMerge><feMergeNode/><feMergeNode in='SourceGraphic'/></feMerge></filter><filter id='f1' x='-50%' y='-50%' width='200%' height='200%'><feOffset result='offOut' in='SourceAlpha' dx='5' dy='5' /><feGaussianBlur result='blurOut' in='offOut' stdDeviation='5' /><feBlend in='SourceGraphic' in2='blurOut' mode='normal' /></filter></defs><g><rect rx='5' height='100' width='100' y='10' x='10' stroke-width='0' fill='#00FF80' filter='url(#f0)'/></g><g stroke-linecap='round' filter='url(#f1)' width='100' height='100' stroke='#00FF7F' stroke-width='10'>","postIcon":"</g></svg>"},"logics":{"text":"Logical operations","description":"Logical operations are available in this section","order":"3","preIcon":"<svg viewBox='0 0 120 120' xmlns='http://www.w3.org/2000/svg'><defs><filter id='f0' x='-50%' y='-50%' width='200%' height='200%'><feGaussianBlur in='SourceAlpha' stdDeviation='3'/><feOffset dx='2' dy='2' result='offsetblur'/><feMerge><feMergeNode/><feMergeNode in='SourceGraphic'/></feMerge></filter><filter id='f1' x='-50%' y='-50%' width='200%' height='200%'><feOffset result='offOut' in='SourceAlpha' dx='5' dy='5' /><feGaussianBlur result='blurOut' in='offOut' stdDeviation='5' /><feBlend in='SourceGraphic' in2='blurOut' mode='normal' /></filter></defs><g><rect rx='5' height='100' width='100' y='10' x='10' stroke-width='0' fill='#FFFF00' filter='url(#f0)'/></g><g stroke-linecap='round' filter='url(#f1)' width='100' height='100' stroke='#00FF7F' stroke-width='10'>","postIcon":"</g></svg>"},"continuous":{"text":"Continuous time","description":"Dynamic operations are available here for continuous time operations","order":"4","preIcon":"<svg viewBox='0 0 120 120' xmlns='http://www.w3.org/2000/svg'><defs><filter id='f0' x='-50%' y='-50%' width='200%' height='200%'><feGaussianBlur in='SourceAlpha' stdDeviation='3'/><feOffset dx='2' dy='2' result='offsetblur'/><feMerge><feMergeNode/><feMergeNode in='SourceGraphic'/></feMerge></filter><filter id='f1' x='-50%' y='-50%' width='200%' height='200%'><feOffset result='offOut' in='SourceAlpha' dx='5' dy='5' /><feGaussianBlur result='blurOut' in='offOut' stdDeviation='5' /><feBlend in='SourceGraphic' in2='blurOut' mode='normal' /></filter></defs><g><rect rx='5' height='100' width='100' y='10' x='10' stroke-width='0' fill='#FF0000' filter='url(#f0)'/></g><g stroke-linecap='round' filter='url(#f1)' width='100' height='100' stroke='#00FF7F' stroke-width='10'>","postIcon":"</g></svg>"},"discrete":{"text":"Discrete time","description":"Dynamic operations are available here for discrete time operations","order":"5","preIcon":"<svg viewBox='0 0 120 120' xmlns='http://www.w3.org/2000/svg'><defs><filter id='f0' x='-50%' y='-50%' width='200%' height='200%'><feGaussianBlur in='SourceAlpha' stdDeviation='3'/><feOffset dx='2' dy='2' result='offsetblur'/><feMerge><feMergeNode/><feMergeNode in='SourceGraphic'/></feMerge></filter><filter id='f1' x='-50%' y='-50%' width='200%' height='200%'><feOffset result='offOut' in='SourceAlpha' dx='5' dy='5' /><feGaussianBlur result='blurOut' in='offOut' stdDeviation='5' /><feBlend in='SourceGraphic' in2='blurOut' mode='normal' /></filter></defs><g><rect rx='5' height='100' width='100' y='10' x='10' stroke-width='0' fill='#80FF00' filter='url(#f0)'/></g><g stroke-linecap='round' filter='url(#f1)' width='100' height='100' stroke='#00FF7F' stroke-width='10'>","postIcon":"</g></svg>"},"hardware":{"text":"Hardware tools","description":"Hardware i/o blocks are available here","order":"6","preIcon":"<svg viewBox='0 0 120 120' xmlns='http://www.w3.org/2000/svg'><defs><filter id='f0' x='-50%' y='-50%' width='200%' height='200%'><feGaussianBlur in='SourceAlpha' stdDeviation='3'/><feOffset dx='2' dy='2' result='offsetblur'/><feMerge><feMergeNode/><feMergeNode in='SourceGraphic'/></feMerge></filter><filter id='f1' x='-50%' y='-50%' width='200%' height='200%'><feOffset result='offOut' in='SourceAlpha' dx='5' dy='5' /><feGaussianBlur result='blurOut' in='offOut' stdDeviation='5' /><feBlend in='SourceGraphic' in2='blurOut' mode='normal' /></filter></defs><g><rect rx='5' height='100' width='100' y='10' x='10' stroke-width='0' fill='#00FFFF' filter='url(#f0)'/></g><g stroke-linecap='round' filter='url(#f1)' width='100' height='100' stroke='#00FF7F' stroke-width='10'>","postIcon":"</g></svg>"}}
	},
	"beforeUpdate": function () {
		removeAlltheObjectURLsForSVGImages();
	},
	"computed": {
		"filteredBlocks": function () {
			if (this[this.selectedCategory].blocks !== undefined)
			return Object.filter(this[this.selectedCategory].blocks, item => (item.name.toLowerCase().search(this.filterForFunctions.toLowerCase())>=0 || item.description.toLowerCase().search(this.filterForFunctions.toLowerCase())>=0));
		}
	},
	"methods": {
		"svgTextToURL": function (svg) {
			svg = this[this.selectedCategory].preIcon + svg + this[this.selectedCategory].postIcon;
			let tempBlob = new Blob([svg], {type: 'image/svg+xml'});
			let url = URL.createObjectURL(tempBlob);
			return url;
		},
		"showSummaryItem": function (index = Date.now().toString()) {
			this[this.selectedCategory].blocks  = Object.assign({},this[this.selectedCategory].blocks);
			console.log(this.selectedCategory);
			this.tempSummaryItem = Object.assign({"name":"","description":"","icon":"","order":"","bid":""},this[this.selectedCategory].blocks[index]);
			this.waitForAProcess.title = "Loading the block details";
			this.waitForAProcess.show++;
			db.collection("blocks").doc(index).get()
			.then(function(doc) {
				app.finishingShowSummaryItem(doc.data(), index);
			})
			.catch (function (error){
				app.finishingShowSummaryItem({}, index);
			});
		},
		"finishingShowSummaryItem": function (data, index) {
			this.tempBlock = Object.assign({"Name":"","Description":"","Icon":"","Parameters":"","Label":"","MaxInTerminals":"","MaxOutTerminals":"","Init":"","End":"","Constructor":"","Destructor":"","RunTimeExec":"","Evaluate":"","Details":"","ValidateParams":""}, data);
			this.waitForAProcess.show--;
			this.selectedBlock = index;
		},
		"saveDataToServer": function () {
			app.$data.waitForAProcess.title = "Saving the block details";
			app.$data.waitForAProcess.show++;
			app.$data[app.$data.selectedCategory].blocks[app.$data.selectedBlock] = Object.assign({},app.$data.tempSummaryItem);
			db.collection("blocks-summary").doc(app.$data.selectedCategory).update(app.$data[app.$data.selectedCategory])
			.then(function(){
				notyf.success('Block summary saved');
				db.collection("blocks").doc(app.$data.selectedBlock).set(app.$data.tempBlock)
				.then(function () {
					notyf.success('Block saved');
					app.$data.waitForAProcess.show--;
				}).catch(function (e) {
					notyf.error('Unable to save the block');
					app.$data.waitForAProcess.show--;
					console.dir(e);
				});
			}).catch(function (e) {
				notyf.error('Unable to save the block summary');
				console.dir(e);
				app.$data.waitForAProcess.show--;
			});
		},
		"deleteDataOnServer": function () {
			app.$data.waitForAProcess.title = "Deleting the block from server";
			app.$data.waitForAProcess.show++;
			delete app.$data[app.$data.selectedCategory].blocks[app.$data.selectedBlock];
			db.collection("blocks-summary").doc(app.$data.selectedCategory).update(app.$data[app.$data.selectedCategory])
			.then(function(){
				notyf.success('Block summary deleted');
				db.collection("blocks").doc(app.$data.selectedBlock).delete()
				.then(function () {
					notyf.success('Block deleted');
					app.$data.waitForAProcess.show--;
					app.$data.selectedBlock=null;
				}).catch(function (e) {
					notyf.error('Unable to delete the block');
					app.$data.waitForAProcess.show--;
					console.dir(e);
					app.$dataselectedBlock=null;
				});
			}).catch(function (e) {
				notyf.error('Unable to delete the block summary');
				console.dir(e);
				app.$data.waitForAProcess.show--;
			});
		}
	}
})
</script>

<script>
</script>
<script>
const functions = firebase.functions();
const db = firebase.firestore();
const settings = {timestampsInSnapshots: true};
db.settings(settings);
var validateUserSession = firebase.functions().httpsCallable('validateUserSession');
var TempRecAttempt;
firebase.auth().onAuthStateChanged(function (user) {
	TempRecAttempt = setInterval(function () {
		console.log("attempt");
		if (app) {
			app.$data.waitForAProcess.title = "Verifying the license.";
			clearInterval(TempRecAttempt);
			user ? handleSignedInUser(user) : handleSignedOutUser();
		}
	}, 500);
});
function handleSignedInUser(user) {
	if (user.uid === "4DYtf7b8cBVgvDJ1Taiz3cPK9qI2"){
		app.$data.waitForAProcess.title = "Loading function blocks summary.";
		for (var blockID in app.$data.functionsCategories) {
			//console.log(blockID);
			db.collection("blocks-summary").doc(blockID).onSnapshot(function(doc) {
				app.$data.waitForAProcess.show++;
				if (doc.exists) app.$data[doc.id] = doc.data();
				app.$data.waitForAProcess.show--;
			});
		}
		app.$data.waitForAProcess.show--;
		loadTheGUI();
	} else window.location.replace("/platform/admin");		
}
function handleSignedOutUser() {
	window.location.replace("/sign-in?redirect=" + location.pathname);
}
function loadTheGUI() {
	
}
</script>
</body>
</html>
